<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getränke Zähler</title>
    <script type="module">
        // Firebase Konfiguration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // Firebase Konfiguration (bitte deine eigenen Einstellungen hier einfügen)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialisierung
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        const currentProject = { projektname: 'dein_projektname' }; // Aktueller Projektnamen hier setzen

        async function initializeDrinks() {
            const drinks = {
                "Helles Bier": { Beschreibung: "Ein erfrischendes, leicht malziges Helles.", Menge: "0,5L", Preis: "3.80", Zaehler: 0, gesperrt: false },
                "Weißbier": { Beschreibung: "Ein vollmundiges Weißbier.", Menge: "0,5L", Preis: "3.80", Zaehler: 0, gesperrt: false },
                // Weitere Getränke hier hinzufügen ...
            };

            await set(ref(database, `/projekte/${currentProject.projektname}/getraenke`), drinks);
            console.log("Getränke wurden in der Datenbank initialisiert:", drinks);
        }

        async function adjustCounter(itemName, delta) {
            const sanitizedKey = itemName.replace(/ /g, "_");
            const itemRef = ref(database, `/projekte/${currentProject.projektname}/getraenke/${sanitizedKey}`);
            
            // Sperre den Zähler
            await update(itemRef, { gesperrt: true });

            try {
                const snapshot = await get(itemRef);
                console.log("Snapshot-Daten:", snapshot.val());

                if (snapshot.exists()) {
                    const drinkData = snapshot.val();
                    console.log("Abgerufene Getränkedaten:", drinkData);

                    let currentCount = drinkData.Zaehler;
                    console.log("Aktueller Zählerwert:", currentCount);

                    // Überprüfen, ob currentCount eine Zahl ist
                    if (typeof currentCount !== 'number' || isNaN(currentCount)) {
                        console.error("Der aktuelle Zählerwert ist ungültig:", currentCount);
                        return;
                    }

                    // Berechne den neuen Zählerwert
                    const newCount = currentCount + delta;

                    // Sicherstellen, dass newCount nicht negativ ist
                    if (newCount < 0) {
                        console.error("Der neue Zählerwert kann nicht negativ sein:", newCount);
                        return;
                    }

                    await update(itemRef, { Zaehler: newCount });
                    console.log(`Zähler für ${itemName} aktualisiert: ${newCount}`);
                } else {
                    console.log("Getränk nicht gefunden. Überprüfe den Namen und die Datenbankstruktur.");
                }
            } catch (error) {
                console.error("Fehler beim Anpassen des Zählers:", error);
            } finally {
                // Entsperre den Zähler nach dem Update
                await update(itemRef, { gesperrt: false });
            }
        }

        // Event Listener für die Buttons
        window.onload = function() {
            document.getElementById("initializeButton").onclick = initializeDrinks;
            document.getElementById("plusButton").onclick = function() {
                adjustCounter("Helles Bier", 1); // Beispiel für Helles Bier erhöhen
            };
            document.getElementById("minusButton").onclick = function() {
                adjustCounter("Helles Bier", -1); // Beispiel für Helles Bier verringern
            };
        };
    </script>
</head>
<body>
    <h1>Getränke Zähler</h1>
    <button id="initializeButton">Getränke initialisieren</button>
    <button id="plusButton">Erhöhen</button>
    <button id="minusButton">Verringern</button>
    <div id="output"></div>
</body>
</html>
